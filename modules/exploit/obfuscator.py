"""
MARS Code Obfuscator - Anti-Analysis & Evasion
"""

import base64
import random
import string
import zlib

class Obfuscator:
    """Obfuscate payloads to evade detection."""
    
    def obfuscate(self, code, language="python"):
        """Obfuscate code based on language."""
        if language.lower() == "python":
            return self._obfuscate_python(code)
        elif language.lower() == "bash":
            return self._obfuscate_bash(code)
        elif language.lower() == "powershell":
            return self._obfuscate_powershell(code)
        else:
            return code  # No obfuscation for unknown languages

    def _obfuscate_python(self, code):
        """Obfuscate Python code using zlib + base64."""
        # Compress and encode
        compressed = zlib.compress(code.encode())
        encoded = base64.b64encode(compressed).decode()
        
        # Create execution wrapper
        var_name = ''.join(random.choices(string.ascii_letters, k=8))
        wrapper = f"""
import zlib,base64
{var_name}="{encoded}"
exec(zlib.decompress(base64.b64decode({var_name})))
"""
        return wrapper.strip()

    def _obfuscate_bash(self, code):
        """Obfuscate Bash code using base64."""
        encoded = base64.b64encode(code.encode()).decode()
        return f"echo {encoded} | base64 -d | bash"

    def _obfuscate_powershell(self, code):
        """Obfuscate PowerShell code using base64."""
        # PowerShell uses UTF-16LE for base64
        encoded = base64.b64encode(code.encode('utf-16le')).decode()
        return f"powershell -nop -enc {encoded}"

    def ai_obfuscate(self, code, language="python"):
        """AI-powered obfuscation (variable renaming, logic masking)."""
        # This would call the AI engine to rewrite code logic
        # For now, it returns the standard obfuscation as a fallback
        return self.obfuscate(code, language)
